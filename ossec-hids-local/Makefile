DESTDIR=/
TARGET_ROOT=target_root
DIR=${TARGET_ROOT}/opt/obsrvbl-ossec/
OSSEC_INIT=${TARGET_ROOT}/etc/ossec-init.conf
TARGET ?= local
VERSION ?= 2.8.3
PREFIX ?= /opt/obsrvbl-ossec

all:
	touch src/Config.OS
	sed -i '/CEXTRA.*/d' src/Config.OS
	echo "CEXTRA=-DLOCAL" >> src/Config.OS
	(cd src; make PREFIX=$(PREFIX) TARGET=$(TARGET) all; make PREFIX=$(PREFIX) TARGET=$(TARGET) build)	

clean:
	rm bin/* || /bin/true
	mkdir -p ${DIR}/rules/translated/
	chmod 750 ${DIR}
	chmod 750 ${DIR}/*
	chmod 750 ${DIR}/rules/translated/
	chmod 750 ${DIR}/rules/translated/* || /bin/true
	(cd src; make clean)
	rm -f src/Config.OS
	rm -f src/analysisd/compiled_rules/compiled_rules.h
	rm -f src/isbigendian.c
	rm -f src/analysisd/ossec-makelists
	rm -f src/analysisd/ossec-logtest
	rm -f src/isbigendian

install:
	mkdir -p ${DIR}
	mkdir -p ${DIR}/system
	mkdir -p ${TARGET_ROOT}/etc/init
	(cd ${DIR}; mkdir -p logs logs/archives logs/alerts logs/firewall bin stats rules queue queue/alerts queue/ossec queue/fts queue/syscheck queue/rootcheck queue/diff queue/agent-info queue/agentless queue/rids tmp var var/run etc etc/shared active-response active-response/bin agentless .ssh)
	cp -pr etc/rules/* ${DIR}/rules/
	cp -pL /etc/localtime ${DIR}/etc/ 2>/dev/null || /bin/true
	cp -p /etc/TIMEZONE ${DIR}/etc/   2>/dev/null || /bin/true
	cp -pr src/ossec* ${DIR}/bin/
	cp -pr src/manage_agents ${DIR}/bin/
	cp -pr src/syscheck_update ${DIR}/bin/
	cp -pr src/verify-agent-conf ${DIR}/bin/
	cp -pr src/clear_stats ${DIR}/bin/
	cp -pr src/list_agents ${DIR}/bin/
	cp -pr src/agent_control ${DIR}/bin/
	cp -pr src/syscheck_control ${DIR}/bin/
	cp -pr src/rootcheck_control ${DIR}/bin/
	cp -pr contrib/util.sh ${DIR}/bin/
	cp -pr src/init/ossec-local.sh ${DIR}/bin/ossec-control
	cp -pr etc/decoder.xml ${DIR}/etc/
	cp -pr etc/local_decoder.xml ${DIR}/etc/ > /dev/null 2>&1 || /bin/true
	cp -pr etc/local_internal_options.conf ${DIR}/etc/ > /dev/null 2>&1 || /bin/true
	cp -pr etc/client.keys ${DIR}/etc/ > /dev/null 2>&1 ||/bin/true
	cp -pr src/agentlessd/scripts/* ${DIR}/agentless/
	cp -pr etc/internal_options.conf ${DIR}/etc/
	cp -pr scripts/ossec-local.conf ${DIR}/etc/ossec.conf
	cp -pr src/rootcheck/db/*.txt ${DIR}/etc/shared/
	cp -p active-response/*.sh ${DIR}/active-response/bin/
	cp -p active-response/firewalls/*.sh ${DIR}/active-response/bin/
	cp -p scripts/ossec-hids-local.conf ${DIR}/system/ossec-hids-local.conf
	cp -p scripts/ossec-hids-local.service ${DIR}/system/ossec-hids-local.service
	echo "DIRECTORY=\"/opt/obsrvbl-ossec\"" > ${OSSEC_INIT}
	echo "VERSION=\"v{VERSION}\"" >> ${OSSEC_INIT}
	echo "DATE=\"`date`\"" >> ${OSSEC_INIT}
	echo "TYPE=\"local\"" >> ${OSSEC_INIT}
